package com.xelitexirish.malwareshield;

import android.content.SharedPreferences;
import android.graphics.Color;
import android.os.Bundle;
import android.support.annotation.Nullable;
import android.support.v7.app.AppCompatActivity;
import android.widget.CompoundButton;
import android.widget.Switch;
import android.widget.TextView;
import android.widget.Toast;

import java.util.List;

import eu.chainfire.libsuperuser.Shell;

public class MainActivity extends AppCompatActivity {

    public TextView textViewHeader;
    public Switch switchEnable;
    public TextView textViewAppStatus;

    public static boolean appRunning = false;
    public static boolean isDeviceRooted = false;

    private static final String HOSTS_FILE_LOCATION = "/system/etc/hosts";

    private static final String HOSTS_FILE = HOSTS_FILE_LOCATION + ".txt";
    private static final String BACKUP_HOSTS_FILE = "/system/etc/hosts-backup.txt";

    @Override
    protected void onCreate(@Nullable Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        this.textViewHeader = (TextView) findViewById(R.id.textViewHeader);
        this.switchEnable = (Switch) findViewById(R.id.switchEnable);
        this.textViewAppStatus = (TextView) findViewById(R.id.textViewAppStatus);

        final SharedPreferences preferences = getSharedPreferences(getResources().getString(R.string.app_name), MODE_PRIVATE);
        appRunning = preferences.getBoolean("APP_RUNNING_STATE", false);

        if(Shell.SU.available()) isDeviceRooted = true;

        ListHelper.initList(this);

        //showServiceDialogBox();

        this.switchEnable.setChecked(appRunning);
        this.switchEnable.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener() {
            @Override
            public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {

                setAppStatus(isChecked);
                enableHostsFile();
            }
        });
    }

    public void setAppStatus(boolean enabled){
        SharedPreferences preferences = getSharedPreferences(getResources().getString(R.string.app_name), MODE_PRIVATE);
        SharedPreferences.Editor editor = preferences.edit();
        editor.putBoolean("APP_RUNNING_STATE", enabled);

        appRunning = enabled;

        if(enabled){
            this.textViewAppStatus.setText(getResources().getString(R.string.app_name) + ": " + "ENABLED");
            this.textViewAppStatus.setTextColor(Color.GREEN);
        }else{
            this.textViewAppStatus.setText(getResources().getString(R.string.app_name) + ": " + "DISABLED");
            this.textViewAppStatus.setTextColor(Color.RED);
        }
    }

    public void enableHostsFile(){
        if(isDeviceRooted){

            List<String> result = Shell.SU.run("cat " + HOSTS_FILE_LOCATION);
            backupHostsFile();
        }
    }

    public void backupHostsFile(){
        Shell.SU.run("cat " + HOSTS_FILE + "> " + BACKUP_HOSTS_FILE);
        Toast.makeText(this, "Hosts file backed up", Toast.LENGTH_SHORT).show();
    }

    public void writeStringToFile(List<String> result){

        String hostsString = "";
        for(String line : result){
            hostsString += line + "\n";
        }

        Shell.SU.run("printf " + hostsString + ">" + HOSTS_FILE);
    }
}
